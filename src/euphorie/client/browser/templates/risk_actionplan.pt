<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      xmlns:meta="http://xml.zope.org/namespaces/meta"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      meta:interpolation="true"
      metal:use-macro="context/@@shell/macros/shell"
      tal:define="
        client nocall:request/client;
        webhelpers nocall:context/@@webhelpers;
      "
      i18n:domain="euphorie"
>

  <body>
    <metal:slot fill-slot="content"
                tal:define="
                  risk nocall:view/risk|nothing;
                  data view/data;
                "
    >
      <tal:block replace="tile:statusmessages" />
      <tal:def define="
                 errors python:exists('actionplan/errors') and actionplan['errors'] or {};
                 action_plans data/custom_measures;
               "
      >

        <!-- Disable validation on the action plan, since an empty budget field falsely gets claimed as being required! -->
        <form class="pat-validation pat-inject pat-scroll"
              action="${context/absolute_url}/@@actionplan"
              method="post"
              data-pat-inject="history: record; source: #step-4-topics; target: #step-4-topics &amp;&amp; source: #content; target: #content"
              data-pat-scroll="selector: #content; trigger: auto; offset: 0"
              data-pat-validation="disable-selector: button[name='next'], .remove-clone;
                                   message-date: This value must be a valid date;
                                   message-datetime: This value must be a valid date and time;
                                   message-email: This value must be a valid email address;
                                   message-number: This value must be a number;
                                   message-min: ${view/message_positive_number};
                                   message-required: This field is required;"
        >
          <div id="content-pane"
               tal:define="
                 solutions view/solutions|nothing;
               "
          >
            <article class="rich pat-well warning"
                     id="${view/risk_number}"
            >
              <tal:block condition="not:view/risk_present">
                <h2 tal:content="risk/title"></h2>
              </tal:block>
              <tal:block define="
                           use_problem_description view/use_problem_description;
                         "
                         condition="view/risk_present"
              >
                <h2 tal:condition="use_problem_description"
                    tal:content="risk/problem_description"
                >The fridges are checked daily.</h2>
                <h2 tal:condition="not:use_problem_description"
                    tal:content="risk/title"
                >The fridges are checked daily.</h2>
              </tal:block>
              <tal:priority tal:define="
                              show_statement python:True;
                            "
              >
                <fieldset tal:define="
                            value data/priority;
                            readonly python:context.risk_type in ['top5'];
                            skip_evaluation view/skip_evaluation;
                          "
                          tal:condition="not:view/skip_evaluation"
                >
                  <input name="priority"
                         type="hidden"
                         value="${python:value}"
                         tal:condition="python:readonly and not skip_evaluation"
                  />
                  <label tal:condition="python:not readonly and not skip_evaluation"
                         i18n:translate="risk_priority"
                  >This is a
                    <select name="priority"
                            i18n:name="priority_value"
                    >
                      <option selected="${python:'selected' if value=='low' else None}"
                              value="low"
                              i18n:translate="risk_priority_low"
                      >low</option>
                      <option selected="${python:'selected' if value=='medium' else None}"
                              value="medium"
                              i18n:translate="risk_priority_medium"
                      >medium</option>
                      <option selected="${python:'selected' if value=='high' else None}"
                              value="high"
                              i18n:translate="risk_priority_high"
                      >high</option>
                    </select>
                  priority risk.
                  </label>
                  <label tal:condition="python:readonly and not skip_evaluation"
                         i18n:translate="risk_priority"
                  >
                  This is a
                    <strong i18n:name="priority_value"
                            i18n:translate=""
                    >risk_priority_${value}</strong>
                  priority risk.
                  </label>
                </fieldset>
                <metal:call use-macro="here/risk_macros/macros/risk_info_actionplan" />
              </tal:priority>
            </article>

            <tal:solutions condition="solutions">
              <div class="pat-modal-pop-over pat-collapsible closed pat-depends"
                   id="measures-panel"
                   data-pat-collapsible="open-trigger: #add-standard-measures; close-trigger: #close-standard-measures"
                   data-pat-depends="${view/solutions_condition}"
              >
                <h2 class="title"
                    i18n:translate=""
                >
                  Standard measures
                </h2>
                <section class="pat-rich description">
                  <p i18n:translate="label_select_measure">
                    Select one or more of the known common measures provided.
                  </p>
                </section>
                <div class="pat-checklist pat-pick-list free-form">
                  <label class="item"
                         tal:repeat="solution solutions"
                  >
                    <input id="sm-${solution/id}"
                           checked="${python: 'checked' if solution['id'] in view.active_standard_measures else None}"
                           name="sm-${solution/id}"
                           type="checkbox"
                    />
                    <span class="text">${solution/description}</span>
                    <span class="functions"><em class="small pat-button icon-plus-circle"
                          i18n:translate="button_add"
                      >Add</em></span>
                  </label>
                </div>
              </div>
              <button id="close-standard-measures"
                      type="button">Close panel</button>
            </tal:solutions>

            <div class="measures pat-clone"
                 id="ActionPlanItemForm"
                 data-pat-clone="template: #measure-template; remove-behaviour: none; remove-confirmation: ${view/delete_confirmation}"
            >

              <!-- Existing Measures -->
              <tal:existing_measures define="
                                       measures view/get_existing_measures;
                                     "
                                     condition="view/use_existing_measures"
              >
                <div class="measure pat-collapsible"
                     tal:repeat="measure measures"
                >
                  <h2><tal:translate i18n:translate="label_implemented_measure">Implemented measure</tal:translate>
                  ${repeat/measure/number}
                  </h2>
                  <h4 i18n:translate="label_description">Description</h4>
                  <p>
                    <tal:measure replace="structure measure/action" />
                  </p>
                </div>
              </tal:existing_measures>


              <tal:solutions repeat="solution solutions">
                <div class="measure pat-collapsible pat-depends"
                     data-pat-depends="condition: sm-${solution/id};"
                >
                  <h2>
                  ${solution/description}
                  </h2>
                  <p class="functions">
                    <a class="icon-trash pat-forward"
                       href="#pick-sm-${solution/id}"
                       title="Remove this measure"
                       data-pat-forward="selector: #sm-${solution/id}"
                       i18n:attributes="title label_remove_measure"
                       i18n:translate=""
                    >Remove</a>
                  </p>
                  <input name="measure.plan_type:records"
                         type="hidden"
                         value="measure_standard"
                  />
                  <input name="measure.solution_id:records"
                         type="hidden"
                         value="${solution/id}"
                  />
                  <input name="measure.action:utf8:ustring:records"
                         type="hidden"
                         value="${solution/action}"
                  />
                  <input name="measure.requirements:utf8:ustring:records"
                         type="hidden"
                         value="${solution/requirements}"
                  />
                  <section class="pat-rich">
                    <h4 i18n:translate="label_description">
                      Description
                    </h4>
                    <p tal:content="structure solution/action_markup">
                      Action
                    </p>
                    <tal:requirements condition="python: 'requirements' not in view.skip_fields and solution['requirements']">
                      <h4 i18n:translate="label_expertise">
                        Expertise
                      </h4>
                      <p>
                        ${solution/requirements}
                      </p>
                    </tal:requirements>
                  </section>
                  <fieldset class="vertical"
                            tal:define="
                              measure python:view.active_standard_measures.get(solution['id'], None);
                            "
                  >
                    <label>
                      <tal:span i18n:translate="label_action_plan_responsible">Who is responsible?</tal:span>
                      <dfn class="icon-help-circle iconified pat-tooltip"
                           data-pat-tooltip="source: content; position-list: lt"
                           i18n:translate="actionplan_measure_responsible_tooltip"
                      >Appoint someone in your company to be responsible for the implementation of this measure. This person will have the authority to take the steps described in the Plan and/or the responsibility to ensure that they are carried out.</dfn>
                      <input class="responsible"
                             name="measure.responsible:utf8:ustring:records"
                             type="text"
                             value="${python:measure.responsible if measure else None}"
                      />
                    </label>
                    <label class="currency"
                           tal:condition="python: 'budget' not in view.skip_fields"
                    >
                      <tal:span i18n:translate="label_action_plan_budget">Budget</tal:span>
                      <em class="message error"
                          tal:condition="exists:errors/budget"
                          i18n:translate="error_invalid_budget"
                      >Please enter the budget in whole Euros.</em>
                      <dfn class="icon-help-circle iconified pat-tooltip"
                           data-pat-tooltip="source: content; position-list: lt"
                           i18n:translate="actionplan_measure_budget_tooltip"
                      >Although some measures do not cost any money, most do. The measures should therefore be budgeted for; include them in the annual budget round if necessary.</dfn>
                      <span class="composed currency-field">
                        <input class="currency"
                               id="solution-budget-${solution/id}"
                               min="0"
                               name="measure.budget:records"
                               type="number"
                               value="${python:measure.budget if measure else None}"
                        />
                      </span>
                    </label>

                    <label tal:define="
                             date_error exists:errors/planning_start_date;
                           "
                    >
                      <tal:label i18n:translate="label_action_plan_start">Planning start</tal:label>
                      <input class="pat-date-picker"
                             id="solution-planning-start-${solution/id}"
                             name="measure.planning_start:records"
                             type="text"
                             value="${python:measure.planning_start if measure else None}"
                             data-pat-date-picker="behavior: styled; week-numbers: show; i18n: ${webhelpers/country_url}/@@date-picker-i18n.json"
                             data-pat-validation="${python:'type: date; not-after: #solution-planning-end-{number}; message-date: {message}'.format(number=solution['id'], message=view.message_date_before) if 'planning_end' not in view.skip_fields else None}"
                      />
                    </label>

                    <label tal:define="
                             date_error exists:errors/planning_end_date;
                           "
                           tal:condition="python: 'planning_end' not in view.skip_fields"
                    >
                      <tal:label i18n:translate="label_action_plan_end">Planning end</tal:label>

                      <input class="pat-date-picker"
                             id="solution-planning-end-${solution/id}"
                             name="measure.planning_end:records"
                             type="text"
                             value="${python:measure.planning_end if measure else None}"
                             data-pat-date-picker="behavior: styled; week-numbers: show; i18n: ${webhelpers/country_url}/@@date-picker-i18n.json"
                             data-pat-validation="type: date; not-before: #solution-planning-start-${solution/id}; message-date: ${view/message_date_after}"
                      />
                    </label>

                  </fieldset>
                </div>
              </tal:solutions>

              <tal:actionplans repeat="actionplan action_plans">
                <div class="measure clone pat-collapsible"
                >
                  <h2><tal:span condition="not:view/use_existing_measures"
                              i18n:translate="Measure"
                    >Measure</tal:span>
                    <tal:span condition="view/use_existing_measures"
                              i18n:translate="Additional Measure"
                    >Additional Measure</tal:span>
                  ${repeat/actionplan/number}
                  </h2>
                  <input name="measure.id:records"
                         type="hidden"
                         value="${actionplan/id}"
                  />
                  <input name="measure.plan_type:records"
                         type="hidden"
                         value="measure_custom"
                  />
                  <p class="functions">
                    <a class="icon-trash remove-clone"
                       i18n:translate="label_remove_measure"
                    >Delete this measure</a>
                  </p>

                  <fieldset class="vertical"
                            id="fields-${repeat/actionplan/number}"
                  >
                    <label><tal:label i18n:translate="label_description">Description</tal:label>
                      <dfn class="icon-help-circle iconified pat-tooltip"
                           data-pat-tooltip="source: content; position-list: lt"
                           i18n:translate="actionplan_measure_tooltip"
                      >Describe: 1) what is your general approach to eliminate or (if the risk is not avoidable) reduce the risk; 2) the specific action(s) required to implement this approach (to eliminate or to reduce the risk)</dfn>
                      <textarea class="actionPlan"
                                name="measure.action:utf8:ustring:records"
                                placeholder="General approach (to eliminate or reduce the risk)"
                                rows="3"
                                type="text"
                                tal:content="actionplan/action|nothing"
                                i18n:attributes="placeholder label_measure_action_plan"
                      ></textarea>
                    </label>
                    <tal:requirements condition="python: 'requirements' not in view.skip_fields">
                      <label><tal:label i18n:translate="label_expertise">Expertise</tal:label>
                      <dfn class="icon-help-circle iconified pat-tooltip"
                           data-pat-tooltip="source: content; position-list: lt"
                           i18n:translate="actionplan_requirements_tooltip"
                      >Describe: 3) the level of expertise needed to implement the measure, for instance &ldquo;common sense (no OSH knowledge required)&rdquo;, &ldquo;no specific OSH expertise, but minimum OSH knowledge or training and/or consultation of OSH guidance required&rdquo;, or &ldquo;OSH expert&rdquo;. You can also describe here any other additional requirement (if any).</dfn>

                        <textarea class="requirements"
                                  name="measure.requirements:utf8:ustring:records"
                                  placeholder="Level of expertise and/or requirements needed"
                                  rows="3"
                                  tal:content="actionplan/requirements|nothing"
                                  i18n:attributes="placeholder label_measure_requirements"
                        ></textarea>
                      </label>
                    </tal:requirements>
                  </fieldset>

                  <fieldset class="vertical"
                            tal:define="
                              number repeat/actionplan/number;
                            "
                  >
                    <label>
                      <tal:span i18n:translate="label_action_plan_responsible">Who is responsible?</tal:span>
                      <dfn class="icon-help-circle iconified pat-tooltip"
                           data-pat-tooltip="source: content; position-list: lt"
                           i18n:translate="actionplan_measure_responsible_tooltip"
                      >Appoint someone in your company to be responsible for the implementation of this measure. This person will have the authority to take the steps described in the Plan and/or the responsibility to ensure that they are carried out.</dfn>
                      <input class="responsible"
                             name="measure.responsible:utf8:ustring:records"
                             type="text"
                             value="${actionplan/responsible|nothing}"
                      />
                    </label>
                    <label class="${python:'error' if exists('errors/budget') else None}"
                           tal:condition="python: 'budget' not in view.skip_fields"
                    >
                      <tal:span i18n:translate="label_action_plan_budget">Budget</tal:span>
                      <em class="message error"
                          tal:condition="exists:errors/budget"
                          i18n:translate="error_invalid_budget"
                      >Please enter the budget in whole Euros.</em>
                      <dfn class="icon-help-circle iconified pat-tooltip"
                           data-pat-tooltip="source: content; position-list: lt"
                           i18n:translate="actionplan_measure_budget_tooltip"
                      >Although some measures do not cost any money, most do. The measures should therefore be budgeted for; include them in the annual budget round if necessary.</dfn>
                      <span class="composed currency-field">
                        <input class="currency"
                               id="input-budget-${number}"
                               min="0"
                               name="measure.budget:records"
                               type="number"
                               value="${actionplan/budget|nothing}"
                        />
                      </span>
                    </label>

                    <label tal:define="
                             date_error exists:errors/planning_start_date;
                           "
                    >
                      <tal:label i18n:translate="label_action_plan_start">Planning start</tal:label>
                      <input class="pat-date-picker"
                             id="planning-start-${number}"
                             name="measure.planning_start:records"
                             type="date"
                             value="${actionplan/planning_start|nothing}"
                             data-pat-date-picker="behavior: styled; week-numbers: show; i18n: ${webhelpers/country_url}/@@date-picker-i18n.json"
                             data-pat-validation="${python:'type: date; not-after: #planning-end-{number}; message-date: {message}'.format(number=number, message=view.message_date_before) if 'planning_end' not in view.skip_fields else None}"
                      />
                    </label>

                    <label tal:define="
                             date_error exists:errors/planning_end_date;
                           "
                           tal:condition="python: 'planning_end' not in view.skip_fields"
                    >
                      <tal:label i18n:translate="label_action_plan_end">Planning end</tal:label>

                      <input class="pat-date-picker"
                             id="planning-end-${number}"
                             name="measure.planning_end:records"
                             type="date"
                             value="${actionplan/planning_end|nothing}"
                             data-pat-date-picker="behavior: styled; week-numbers: show; i18n: ${webhelpers/country_url}/@@date-picker-i18n.json"
                             data-pat-validation="type: date; not-before: #planning-start-${number}; message-date: ${view/message_date_after}"
                      />
                    </label>
                  </fieldset>
                </div>
              </tal:actionplans>
            </div>

            <div class="button-bar">
              <tal:solutions condition="solutions">
                <button class="pat-button icon-plus-circle pat-depends ${view/style_buttons}"
                        id="add-standard-measures"
                        title="Add another measure"
                        type="button"
                        data-pat-depends="${view/solutions_condition}"
                        i18n:translate="label_select_standard_measures"
                >Select standard measures</button>
              </tal:solutions>
              <button class="add-clone pat-button icon-plus-circle ${view/style_buttons}"
                      id="addMeasureButton"
                      title="Add another measure"
                      type="button"
                      i18n:translate="label_extra_add_measure"
              >Add an extra measure</button>
            </div>

            <div class="measure pat-collapsible"
                 id="measure-template"
                 hidden="hidden"
            >

              <h2><tal:span condition="not:view/use_existing_measures"
                          i18n:translate="Measure"
                >Measure</tal:span>
                <tal:span condition="view/use_existing_measures"
                          i18n:translate="Additional Measure"
                >Additional Measure</tal:span>
              #{1}
              </h2>
              <p class="functions">
                <a class="icon-trash remove-clone"
                   i18n:translate="label_remove_measure"
                >Delete this measure</a>
              </p>

              <fieldset class="vertical"
                        id="fields-#{1}"
              >
                <label><tal:label i18n:translate="label_description">Description</tal:label>
                  <dfn class="icon-help-circle iconified pat-tooltip"
                       data-pat-tooltip="source: content; position-list: lt"
                       i18n:translate="actionplan_measure_tooltip"
                  >Describe: 1) what is your general approach to eliminate or (if the risk is not avoidable) reduce the risk; 2) the specific action(s) required to implement this approach (to eliminate or to reduce the risk)</dfn>
                  <textarea class="actionPlan"
                            autofocus="autofocus"
                            name="measure.action:utf8:ustring:records"
                            placeholder="General approach (to eliminate or reduce the risk)"
                            rows="3"
                            i18n:attributes="placeholder label_measure_action_plan"
                  ></textarea>
                </label>
                <tal:requirements condition="python: 'requirements' not in view.skip_fields">
                  <label><tal:label i18n:translate="label_expertise">Expertise</tal:label>
                    <dfn class="icon-help-circle iconified pat-tooltip"
                         data-pat-tooltip="source: content; position-list: lt"
                         i18n:translate="actionplan_requirements_tooltip"
                    >Describe: 3) the level of expertise needed to implement the measure, for instance &ldquo;common sense (no OSH knowledge required)&rdquo;, &ldquo;no specific OSH expertise, but minimum OSH knowledge or training and/or consultation of OSH guidance required&rdquo;, or &ldquo;OSH expert&rdquo;. You can also describe here any other additional requirement (if any).</dfn>
                    <textarea class="requirements"
                              name="measure.requirements:utf8:ustring:records"
                              placeholder="Level of expertise and/or requirements needed"
                              rows="3"
                              i18n:attributes="placeholder label_measure_requirements"
                    ></textarea>
                  </label>
                </tal:requirements>
              </fieldset>

              <fieldset class="vertical">
                <label>
                  <tal:span i18n:translate="label_action_plan_responsible">Who is responsible?</tal:span>
                  <dfn class="icon-help-circle iconified pat-tooltip"
                       data-pat-tooltip="source: content; position-list: lt"
                       i18n:translate="actionplan_measure_responsible_tooltip"
                  >Appoint someone in your company to be responsible for the implementation of this measure. This person will have the authority to take the steps described in the Plan and/or the responsibility to ensure that they are carried out.</dfn>
                  <input class="responsible"
                         name="measure.responsible:utf8:ustring:records"
                         type="text"
                  />
                </label>
                <label class="currency"
                       tal:condition="python: 'budget' not in view.skip_fields"
                >
                  <tal:span i18n:translate="label_action_plan_budget">Budget</tal:span>
                  <dfn class="icon-help-circle iconified pat-tooltip"
                       data-pat-tooltip="source: content; position-list: lt"
                       i18n:translate="actionplan_measure_budget_tooltip"
                  >Although some measures do not cost any money, most do. The measures should therefore be budgeted for; include them in the annual budget round if necessary.</dfn>
                  <span class="composed currency-field">
                    <input class="currency"
                           id="input-budget-#{1}"
                           min="0"
                           name="measure.budget:records"
                           type="number"
                    />
                  </span>
                </label>
                <label>
                  <tal:label i18n:translate="label_action_plan_start">Planning start</tal:label>
                  <input class="pat-date-picker"
                         id="planning-start-#{1}"
                         name="measure.planning_start:records"
                         type="date"
                         data-pat-date-picker="behavior: styled; week-numbers: show; i18n: ${webhelpers/country_url}/@@date-picker-i18n.json"
                         data-pat-validation="${python:'type: date; not-after: #planning-end-#{1}; message-date: %s' % view.message_date_before if 'planning_end' not in view.skip_fields else None}"

                  />
                </label>
                <label tal:condition="python: 'planning_end' not in view.skip_fields">
                  <tal:label i18n:translate="label_action_plan_end">Planning end</tal:label>
                  <input class="pat-date-picker"
                         id="planning-end-#{1}"
                         name="measure.planning_end:records"
                         type="date"
                         data-pat-date-picker="behavior: styled; week-numbers: show; i18n: ${webhelpers/country_url}/@@date-picker-i18n.json"
                         data-pat-validation="type:date; not-before: #planning-start-#{1}; message-date: ${view/message_date_after}"
                  />
                </label>
              </fieldset>
            </div>

            <fieldset id="comments">
              <textarea id="commentsField"
                        cols="70"
                        name="comment:utf8:ustring"
                        placeholder="Please leave any comments you may have on the question above in this field. These comments will be used in the action plan."
                        rows="3"
                        tal:content="data/comment|nothing"
                        i18n:attributes="placeholder label_comment"
              ></textarea>
            </fieldset>

          </div>
          <p class="button-bar"
             id="nav-bar"
          >
            <button class="pat-button back"
                    name="next"
                    type="submit"
                    value="previous"
                    i18n:translate="label_previous"
            >Previous</button>
            <button class="pat-button continue"
                    name="next"
                    type="submit"
                    value="next"
                    i18n:translate="label_save_and_continue"
            >Save and continue</button>
          </p>
        </form>
      </tal:def>
    </metal:slot>
  </body>
</html>
